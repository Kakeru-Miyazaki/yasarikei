<!DOCTYPE html>
<meta charset="utf-8" />
<style>
  .html {
    font-family: "Lora", serif;
    font-family: "Ubuntu", sans-serif;
  }

  .body {
    height: auto;
    width: auto;
  }

  .background {
    fill: black;
    pointer-events: all;
  }

  #states {
    fill: grey;
  }

  #state-borders {
    fill: none;
    stroke: black;
    /* stroke-width: 1.5px; */
    stroke-linejoin: round;
    stroke-linecap: round;
    pointer-events: none;
  }
  .wave {
    pointer-events: none;
  }
</style>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Lora&family=Ubuntu:wght@300&display=swap"
  rel="stylesheet"
/>
<link rel="stylesheet" href="sidebar.css" />
<link rel="stylesheet" href="button.css" />
<link rel="stylesheet" href="form.css" />
<link rel="stylesheet" href="clock.css" />
<link rel="stylesheet" href="menu.css" />
<body bgcolor="black">
  <!-- >>> for sidebar >>> -->
  <input type="checkbox" class="openSidebarMenu" id="openSidebarMenu" checked />
  <label for="openSidebarMenu" class="sidebarIconToggle">
    <div class="spinner diagonal part-1"></div>
    <div class="spinner horizontal"></div>
    <div class="spinner diagonal part-2"></div>
  </label>
  <div id="sidebarMenu">
    <div class="wrapper">
      <!-- >>> for search >>> -->

      <div class="cp_iptxt">
        <input class="ef" type="text" placeholder="" id="inputEkiname" />
        <label>Station Name</label>
        <span class="focus_line"></span>
      </div>

      <br />
      <a href="javascript:ekiSearch();" class="btn btn-svg">
        <svg>
          <rect x="2" y="2" rx="0" fill="none" width="200" height="50"></rect>
        </svg>
        <span>SEARCH</span>
      </a>
    </div>
    <!-- <<< for search <<< -->

    <!-- >>> for menu >>> -->
    <div class="container">
      <div class="radio-tile-group">
        <!-- <form name="formMenu"> -->
        <div class="input-container">
          <input
            id="one"
            class="radio-button"
            type="radio"
            name="radio"
            checked
            value="one"
            onchange="onMenuChange()"
          />
          <div class="radio-tile">
            <div class="icon one-icon">
              <img src="./fig/one_.png" width="30" height="30" />
            </div>
          </div>
        </div>

        <div class="input-container">
          <input
            id="meet"
            class="radio-button"
            type="radio"
            name="radio"
            value="meet"
            onchange="onMenuChange()"
          />
          <div class="radio-tile">
            <div class="icon meet-icon">
              <img src="./fig/meet_.png" width="50" height="23" />
            </div>
          </div>
        </div>

        <div class="input-container">
          <input
            id="meetWithTime"
            class="radio-button"
            type="radio"
            name="radio"
            value="meetWithTime"
            onchange="onMenuChange()"
          />
          <div class="radio-tile">
            <div class="icon car-icon">
              <img src="./fig/meetWithTime_.png" width="45" height="36" />
            </div>
          </div>
        </div>
        <!-- </form> -->
      </div>
    </div>
    <!-- <<< for menu <<< -->

    <!-- >>> for clock >>> -->
    <div class="wrapper">
      <div id="clockAndTime">
        <div class="clock" id="clock" draggable="true">
          <div class="scale" id="scale"></div>
          <div class="hour line"></div>
          <div class="min line" draggable="true" id="minLine"></div>
        </div>
        <div id="setTime" class="wrapper"></div>
        <br />
      </div>
      <a href="javascript:show_whole_paths();" class="btn btn-svg">
        <svg>
          <rect x="2" y="2" rx="0" fill="none" width="200" height="50"></rect>
        </svg>
        <span>RUN</span>
      </a>
    </div>
    <!-- <<< for clock <<< -->
  </div>

  <!-- <<< for sidebar <<< -->
  <script src="./d3.js" charset="utf-8"></script>
  <script src="//d3js.org/topojson.v1.min.js"></script>
  <script src="./search.js"></script>
  <script src="./menu.js"></script>
  <script src="./clock.js"></script>
  <script src="./tooltip.js"></script>
  <script>
    var w = window,
      d = document,
      e = d.documentElement,
      BODY = d.getElementsByTagName("body")[0];
    var width = w.innerWidth || e.clientWidth || BODY.clientWidth;
    var height = w.innerHeight || e.clientHeight || BODY.clientHeight;

    var userSetHour = 0;
    var userSetTime = 30;
    var stationQueue = [];
    var ekiNameToEkiData = {};
    var clicked_stations = new Set();
    var goal_station_name_ID = [];
    var last_center_station = NaN;
    var last_center_station_red_flag = 0;
    var last_nearest_station = NaN;
    var last_nearest_station_red_flag = 0;

    d3.select(window).on("resize", resizing);

    var projection = d3
      .geoMercator()
      .scale(60000)
      .center([139.463191, 35.710335])
      .translate([width / 2, height / 2]);

    var path = d3.geoPath().projection(projection);

    var zoom = d3
      .zoom()
      .scaleExtent([1, 200])
      .on("zoom", function (event) {
        g.selectAll("path").attr("transform", event.transform);
        //駅
        g.selectAll(".circle")
          .attr("transform", event.transform)
          .attr("r", function (d) {
            return (1.2 * Math.sqrt(d.noriire)) / Math.cbrt(event.transform.k);
          })
          .attr("stroke-width", 0.4 / Math.cbrt(event.transform.k));
        //波
        g.selectAll(".wave")
          .attr("transform", event.transform)
          .attr("r", function (d) {
            return 100 / Math.cbrt(event.transform.k);
          })
          .attr("stroke-width", 0.2 / Math.cbrt(event.transform.k));
        //線
        g.selectAll("line")
          .attr("transform", event.transform)
          .attr("stroke-width", 2 / Math.cbrt(event.transform.k));
        //境界
        g.selectAll("#state-borders").attr(
          "stroke-width",
          1.5 / Math.cbrt(event.transform.k)
        );
      });

    var svg = d3
      .select("body")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .attr("x", 0)
      .attr("y", 0);

    var g = svg.append("g").call(zoom);

    g.append("rect")
      .attr("class", "background")
      .attr("width", width)
      .attr("height", height)
      .on("click", reset_selections);
    // .attr("stroke", "lightgrey")
    // .attr("stroke-width", 20);

    function reset_selections() {
      g.selectAll(".wave").remove();
      // g.selectAll(".wave_in").remove();
      g.selectAll("circle").attr("fill-opacity", 0.2).attr("fill", "white");
      g.selectAll("line")
        .transition()
        .duration(500)
        .ease(d3.easeLinear)
        .attr("opacity", 1);
      clicked_stations.clear();
      last_center_station = NaN;
    }

    showMap().then(() => {
      d3.csv("joinWithIdoKeido.csv")
        .then(function (data) {
          showline(data);
        })
        .then(() => {
          d3.csv("data.csv").then(function (data) {
            data.forEach(function (d) {
              ekiNameToEkiData[d.name] = d;
            });
            showCircle(data);
          });
        });
    });

    function showMap() {
      return new Promise((resolve) => {
        d3.json("./tokyo.topojson")
          .then(function (tk) {
            var tokyo = topojson.feature(tk, tk.objects.tokyo);
            g.append("g")
              .attr("id", "states")
              .selectAll("path")
              .data(tokyo.features)
              .enter()
              .append("path")
              .attr("d", path);
            // .on("click", clicked);

            g.append("path")
              .datum(
                topojson.mesh(tk, tk.objects.tokyo, function (a, b) {
                  return a !== b;
                })
              )
              .attr("id", "state-borders")
              .attr("stroke-width", 1.5)
              .attr("d", path);
          })
          .then(() => {
            resolve(true);
          });
      });
    }

    function showline(data) {
      function position(p) {
        p.attr("x1", function (d) {
          return projection([d.fromIdo, d.fromKeido])[0];
        });
        p.attr("y1", function (d) {
          return projection([d.fromIdo, d.fromKeido])[1];
        });
        p.attr("x2", function (d) {
          return projection([d.toIdo, d.toKeido])[0];
        });
        p.attr("y2", function (d) {
          return projection([d.toIdo, d.toKeido])[1];
        });
        p.attr("stroke", function (d) {
          return "rgb(" + d.r + "," + d.g + "," + d.b + ")";
        });
        p.attr("class", function (d) {
          return (
            "s" + d.fromID + "_" + d.toID + " " + "s" + d.toID + "_" + d.fromID
          );
        });
      }
      var links = g
        .selectAll("line")
        .data(data)
        .enter()
        .append("line")
        .attr("stroke-width", 2)
        .attr("class", function (d) {
          return (
            "s" + d.fromID + "_" + d.toID + " " + "s" + d.toID + "_" + d.fromID
          );
        })
        .call(position);

      links.append("title").text(function (d) {
        return d.routeName;
      });
    }

    function showCircle(data) {
      function position(p) {
        p.attr("cx", function (d) {
          return projection([d.ido, d.keido])[0];
        });
        p.attr("cy", function (d) {
          return projection([d.ido, d.keido])[1];
        });
        p.attr("r", function (d) {
          return 1.2 * Math.sqrt(d.noriire);
        });
        p.attr("stroke-width", 0.4);
        p.attr("id", function (d) {
          return d.name + d.GroupID;
        });
      }

      var circle = g
        .selectAll("circle")
        .data(data)
        .enter()
        .append("circle")
        .sort(order)
        .attr("class", "circle")
        .attr("fill", "white")
        .attr("fill-opacity", 0.2)
        .attr("stroke", "white")
        .call(position);

      circle.append("title").text(function (d) {
        return d.name;
      });

      // circle.on("mouseover", onMouseover).on("mouseout", onMouseout);
      function order(a, b) {
        return b.noriire - a.noriire;
      }

      circle.on("click", function (event, d) {
        d3.select(this)
          .transition()
          .duration(500)
          .ease(d3.easeLinear)
          .attr("fill-opacity", 1)
          .attr("fill", "red");

        var circle_cx = d3.select(this).attr("cx");
        var circle_cy = d3.select(this).attr("cy");
        var circle_transform = d3.select(this).attr("transform");
        var kakudairitu = 0.2 / d3.select(this).attr("stroke-width");
        // 選択した駅から波動を発生させる
        var wave = g
          .append("circle")
          .attr("class", "wave wave_out")
          .attr("stroke", "white")
          .attr("stroke-width", 0.2)
          .attr("opacity", 1)
          .attr("fill-opacity", 0)
          .attr("cx", circle_cx)
          .attr("cy", circle_cy)
          .attr("r", 0)
          .attr("transform", circle_transform);

        wave
          .append("animate")
          .attr("class", "wave_out_animation")
          .attr("attributeName", "r")
          .attr("begin", "0s")
          .attr("dur", "1s")
          .attr("from", "0")
          .attr("to", "25")
          .attr("repeatCount", "indefinite");

        console.log(d);
        clicked_stations.add(d.GroupID);
        console.log(clicked_stations);
      });
      //circle.on("mouseover", showStaionTooltip)
      //          .on("mouseout", hideStationTooltip);
    }

    //runされた時呼び出される関数
    function show_whole_paths() {
      if (clicked_stations.size == 0) {
        // 何も選択せずにrunされた時
        console.log("no stations selected!");
        return;
      } else if (clicked_stations.size == 1) {
        //一回の時
        console.log("selected one station");
        d3.selectAll("line")
          .transition()
          .duration(500)
          .ease(d3.easeLinear)
          .attr("opacity", 0);
        for (var value of clicked_stations) {
          show_within_stations(value);
        }
      } else {
        console.log("selected more than one station");
        d3.selectAll("line")
          .transition()
          .duration(500)
          .ease(d3.easeLinear)
          .attr("opacity", 0);
        show_center_station();
      }
    }

    //ある駅からn分以内に行ける駅を表示する関数
    function show_within_stations(groupid) {
      within_T_min(groupid, userSetHour * 60 + userSetTime, stationQueue).then(
        () => {
          while (stationQueue.length) {
            var rinsetsu_stations = stationQueue.shift();
            g.select(".s" + rinsetsu_stations[0] + "_" + rinsetsu_stations[1])
              .transition()
              .duration(500)
              .ease(d3.easeLinear)
              .attr("opacity", 1);
          }
        }
      );
    }

    //複数人で待ち合わせを表示する関数
    function show_center_station() {
      meet_up(clicked_stations, 180, stationQueue, goal_station_name_ID).then(
        () => {
          while (stationQueue.length) {
            var rinsetsu_stations = stationQueue.shift();
            g.select(".s" + rinsetsu_stations[0] + "_" + rinsetsu_stations[1])
              .transition()
              .duration(500)
              .ease(d3.easeLinear)
              .attr("opacity", 1);
          }
          if (goal_station_name_ID.length > 0) {
            // center_stationは駅名+グループID
            console.log(goal_station_name_ID);
            var center_station = goal_station_name_ID.shift();

            if (last_center_station != NaN) {
              if (last_center_station_red_flag == 1) {
                g.select("#" + last_center_station)
                  .attr("fill-opacity", 1)
                  .attr("fill", "red");
              } else {
                g.select("#" + last_center_station)
                  .transition()
                  .duration(500)
                  .ease(d3.easeLinear)
                  .attr("fill-opacity", 0.2)
                  .attr("fill", "white");
              }
              g.select(".wave_in").remove();
            }
            console.log(g.select("#" + center_station).attr("fill"));
            console.log(last_nearest_station_red_flag);
            if (
              g.select("#" + center_station).attr("fill") == "rgb(255, 0, 0)" ||
              g.select("#" + center_station).attr("fill") == "red" ||
              (g.select("#" + center_station).attr("fill") ==
                "rgb(148, 0, 211)" &&
                last_nearest_station_red_flag == 1)
            ) {
              console.log("conter_station_red !!");
              last_center_station_red_flag = 1;
            } else {
              console.log("conter_station_not_red !!");
              last_center_station_red_flag = 0;
            }
            g.select("#" + center_station)
              .transition()
              .duration(500)
              .ease(d3.easeLinear)
              .attr("fill-opacity", 1)
              .attr("fill", "lime");
            last_center_station = center_station;
            var circle_cx = d3.select("#" + center_station).attr("cx");
            var circle_cy = d3.select("#" + center_station).attr("cy");
            var circle_transform = d3
              .select("#" + center_station)
              .attr("transform");
            var kakudairitu =
              0.2 / d3.select("#" + center_station).attr("stroke-width");
            g.selectAll(".wave_out_animation").attr("to", 8);

            var wave = g
              .append("circle")
              .attr("stroke", "white")
              .attr("stroke-width", 0.2)
              .attr("class", "wave wave_in")
              .attr("opacity", 1)
              .attr("fill-opacity", 0)
              .attr("cx", circle_cx)
              .attr("cy", circle_cy)
              .attr("r", 0)
              .attr("transform", circle_transform);

            wave
              .append("animate")
              .attr("attributeName", "r")
              .attr("begin", "0s")
              .attr("dur", "1s")
              .attr("from", "25")
              .attr("to", "0")
              .attr("repeatCount", "indefinite");

            if (last_nearest_station != NaN) {
              if (last_nearest_station_red_flag == 1) {
                g.select("#" + last_nearest_station)
                  .attr("fill-opacity", 1)
                  .attr("fill", "red");
              } else {
                g.select("#" + last_nearest_station)
                  .transition()
                  .duration(500)
                  .ease(d3.easeLinear)
                  .attr("fill-opacity", 0.2)
                  .attr("fill", "white");
              }
            }

            //ハブ駅の表示
            if (goal_station_name_ID.length > 0) {
              var nearest_hub_station = goal_station_name_ID.shift();
              // if (last_nearest_station != NaN) {
              //   console.log(last_nearest_station_red_flag);
              //   if (last_nearest_station_red_flag == 1) {
              //     g.select("#" + last_nearest_station)
              //       .attr("fill-opacity", 1)
              //       .attr("fill", "red");
              //   } else {
              //     g.select("#" + last_nearest_station)
              //       .transition()
              //       .duration(500)
              //       .ease(d3.easeLinear)
              //       .attr("fill-opacity", 0.2)
              //       .attr("fill", "white");
              //   }
              //   // g.select(".wave_in").remove();
              // }
              console.log(g.select("#" + nearest_hub_station).attr("fill"));
              if (
                g.select("#" + nearest_hub_station).attr("fill") ==
                  "rgb(255, 0, 0)" ||
                g.select("#" + nearest_hub_station).attr("fill") == "red" ||
                (g.select("#" + center_station).attr("fill") ==
                  "rgb(0, 255, 0)" &&
                  last_center_station_red_flag == 1)
              ) {
                console.log("hub_station_red !!");
                last_nearest_station_red_flag = 1;
              } else {
                console.log("hub_station_not_red !!");
                last_nearest_station_red_flag = 0;
              }
              g.select("#" + nearest_hub_station)
                .transition()
                .duration(500)
                .ease(d3.easeLinear)
                .attr("fill-opacity", 1)
                .attr("fill", "darkviolet");
              last_nearest_station = nearest_hub_station;
            }
          }
        }
      );
    }

    function resizing() {
      w = window;
      e = d.documentElement;
      BODY = d.getElementsByTagName("body")[0];
      width = w.innerWidth || e.clientWidth || BODY.clientWidth;
      height = w.innerHeight || e.clientHeight || BODY.clientHeight;
      svg.attr("width", width).attr("height", height);
      svg.selectAll(".background").attr("width", width).attr("height", height);
    }

    function openGoogleMap(d) {
      window.open(
        "https://www.google.co.jp/maps/search/%E3%83%AC%E3%82%B9%E3%83%88%E3%83%A9%E3%83%B3+" +
          d.name
      );
    }

    var isAleradySearched = false;
    function ekiSearch() {
      isAleradySearched = true;
      var inputName = document.getElementById("inputEkiname").value;
      if (ekiNameToEkiData[inputName] == undefined) {
        console.log(document.getElementById("inputEkiname").value.slice(0, 4));
        // alert(inputName + "駅が見つかりません");
        if (
          document.getElementById("inputEkiname").value.slice(0, 3) != "Not"
        ) {
          document.getElementById("inputEkiname").value =
            "Not Found : " + inputName;
        }
        return;
      }
      inputEkidata = ekiNameToEkiData[inputName];

      console.log("#" + inputEkidata.name + inputEkidata.GroupID);
      var kakudairitu =
        0.2 /
        d3
          .select("#" + inputEkidata.name + inputEkidata.GroupID)
          .attr("stroke-width");
      console.log("#" + inputEkidata.name + inputEkidata.GroupID);
      g.select("#" + inputEkidata.name + inputEkidata.GroupID)
        .transition()
        .duration(1000)
        .ease(d3.easeSin, d3.easeSinInOut)
        .attr("r", function (d) {
          console.log(d);
          return (1.2 * Math.sqrt(d.noriire) * 20) / kakudairitu ** 3 / 2;
        })
        .transition()
        .ease(d3.easeSin, d3.easeSinInOut)
        .attr("r", function (d) {
          return (1.2 * Math.sqrt(d.noriire)) / kakudairitu / 2;
        });
    }

    function clearForm() {
      console.log(document.getElementById("inputEkiname").composing);
      if (isAleradySearched) {
        document.getElementById("inputEkiname").value = "";
        isAleradySearched = false;
      }
      return;
    }

    document.getElementById("inputEkiname").addEventListener("keydown", (e) => {
      if (e.keyCode == 13) {
        ekiSearch();
      }
      if (e.keyCode == 229) {
        clearForm();
      }
    });
  </script>
</body>
